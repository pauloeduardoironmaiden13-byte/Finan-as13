<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controle Financeiro</title>
    <!-- Bibliotecas Gr√°ficas e Utilit√°rios -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap');

        :root {
            /* --- VARIAVEIS BASE --- */
            --radius: 16px;
            --font-main: 'Nunito', sans-serif;
            --font-title: 'Chakra Petch', sans-serif;
            --transition-speed: 0.3s;
        }

        /* --- TEMA ESCURO (GOKU BASE) --- */
        body.theme-dark {
            --bg-image: url('https://i.pinimg.com/736x/69/68/3f/69683f67bbde5da0e76957fa8c2f28a5.jpg');
            --bg-overlay: rgba(13, 15, 20, 0.85); 
            --nav-bg: #1a2035;
            --card-bg: rgba(30, 35, 50, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --accent: #ff7e00; /* Laranja */
            --secondary: #2855ff; /* Azul */
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0,0,0,0.5);
        }

        /* --- TEMA CLARO (KAIOKEN) --- */
        body.theme-light {
            --bg-image: url('https://wallpapers.com/images/hd/dbz-son-goku-transformations-9llax3evn2xks53i.jpg');
            --bg-overlay: rgba(255, 255, 255, 0.9);
            --nav-bg: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --accent: #ea580c;
            --secondary: #0284c7;
            --border-color: rgba(0,0,0,0.1);
            --shadow-color: rgba(0,0,0,0.1);
        }

        /* --- TEMA SUPER SAIYAJIN --- */
        body.theme-ssj {
            --bg-image: url('https://preview.redd.it/ihv076kym8q61.jpg?width=1080&crop=smart&auto=webp&s=d9480d7530ae38848bac72962f28a545d05c89db');
            --bg-overlay: rgba(30, 20, 0, 0.6);
            --nav-bg: #2a1a00;
            --card-bg: rgba(40, 30, 0, 0.9);
            --text-primary: #fffbeb;
            --text-secondary: #fcd34d;
            --accent: #fbbf24; /* Dourado */
            --secondary: #f59e0b;
            --border-color: #fbbf24;
            --shadow-color: rgba(251, 191, 36, 0.4);
        }

        /* Anima√ß√µes */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 1; background: white; }
            100% { opacity: 0; }
        }
        body.transforming { animation: shake 0.5s; overflow: hidden; }
        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none; z-index: 9999; opacity: 0;
        }
        body.transforming #flash-overlay { animation: flash 0.8s; }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            color: var(--text-primary);
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            overflow: hidden; display: flex; flex-direction: column;
            transition: background 0.5s ease;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
        }

        .app-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-overlay); z-index: 0;
            transition: background 0.5s ease;
        }

        /* --- HEADER --- */
        .top-bar {
            height: 80px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; z-index: 10;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--border-color);
        }

        .logo-area { display: flex; align-items: center; gap: 8px; }
        .logo-icon {
            width: 40px; height: 40px;
            background: var(--accent); color: #fff;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 2px solid #fff; box-shadow: 0 0 15px var(--accent);
            font-weight: 800; font-size: 1.2em;
        }
        .app-title { font-family: var(--font-title); font-weight: 700; font-size: 1.1em; color: var(--accent); text-transform: uppercase; text-shadow: 2px 2px 0 rgba(0,0,0,0.5); }

        .controls { display: flex; gap: 8px; align-items: center; }
        
        input[type="month"] {
            background: #ffffff !important; 
            color: #000000 !important;
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 5px;
            font-family: var(--font-title);
            font-weight: 700;
            cursor: pointer;
            z-index: 20;
            width: 125px;
        }

        .icon-btn {
            background: var(--card-bg); border: 2px solid var(--accent);
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--accent); cursor: pointer; transition: 0.3s;
            box-shadow: 0 0 10px var(--shadow-color);
        }
        .icon-btn:hover { transform: scale(1.1); background: var(--accent); color: #fff; }

        /* --- MAIN --- */
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column;
            overflow: hidden; position: relative; z-index: 5;
            padding-bottom: 90px;
        }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 20px; }

        /* --- CARDS & UI --- */
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-bottom: 20px; }
        
        .z-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px; position: relative;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: 0.2s;
        }
        .z-card h3 { 
            margin: 0 0 5px 0; font-size: 0.75em; text-transform: uppercase; 
            color: var(--text-secondary); font-family: var(--font-title); letter-spacing: 1px;
        }
        .z-card .val { font-size: 1.3em; font-weight: 800; color: var(--text-primary); }
        .z-card.accent .val { color: var(--accent); text-shadow: 0 0 10px var(--shadow-color); }
        .z-card.green .val { color: #22c55e; }
        .z-card.red .val { color: #ef4444; }

        /* --- LISTAS --- */
        .trans-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .trans-item {
            background: var(--card-bg); border-radius: 12px; padding: 12px;
            display: flex; align-items: center; justify-content: space-between;
            border-left: 4px solid transparent; border-bottom: 1px solid var(--border-color);
        }
        .trans-item.receita { border-left-color: #22c55e; }
        .trans-item.despesa { border-left-color: #ef4444; }
        .trans-item.pago { border-left-color: var(--secondary); opacity: 0.7; }

        /* --- CHART BOX --- */
        .chart-box { 
            background: var(--card-bg); padding: 15px; border-radius: var(--radius); 
            height: 250px; margin-top: 20px; border: 1px solid var(--border-color); 
            position: relative;
        }
        .chart-title { position: absolute; top: 10px; left: 0; width: 100%; text-align: center; font-size: 0.9em; color: var(--text-secondary); font-family: var(--font-title); font-weight: 700; z-index: 5; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 450px;
            background: var(--nav-bg); border-radius: 50px;
            display: flex; justify-content: space-around; align-items: center;
            padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 2px solid var(--accent); z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-secondary); width: 50px; height: 50px; border-radius: 50%;
            transition: 0.3s; position: relative; cursor: pointer;
        }
        .nav-item.active {
            background: var(--accent); color: #fff;
            transform: translateY(-20px) scale(1.1);
            box-shadow: 0 0 15px var(--accent); border: 2px solid #fff;
        }
        .nav-item span { 
            font-size: 0.6em; position: absolute; bottom: -18px; opacity: 0; 
            transition: 0.2s; white-space: nowrap; color: var(--accent); font-weight: 700;
        }
        .nav-item.active span { opacity: 1; bottom: -25px; }

        /* --- COFRE --- */
        .vault-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; min-height: 400px; text-align: center; }
        .pin-display { display: flex; gap: 15px; margin-bottom: 30px; }
        .pin-dot { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--accent); transition: 0.2s; }
        .pin-dot.filled { background: var(--accent); box-shadow: 0 0 10px var(--accent); transform: scale(1.2); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .num-btn {
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--card-bg); border: 2px solid var(--border-color);
            color: var(--text-primary); font-size: 1.5em; font-family: var(--font-title);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.1s;
        }
        .num-btn:active { background: var(--accent); color: #fff; transform: scale(0.9); }

        /* --- MODAL & BUTTONS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal.open { display: flex; }
        .modal-content { background: var(--nav-bg); width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; border: 2px solid var(--accent); box-shadow: 0 0 40px var(--shadow-color); position: relative; }

        .btn-z {
            background: var(--accent); color: #fff; border: none; padding: 12px;
            width: 100%; border-radius: 12px; font-family: var(--font-title); font-weight: 700;
            text-transform: uppercase; cursor: pointer; letter-spacing: 1px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-z:active { transform: translateY(3px); box-shadow: none; }
        .btn-z.red { background: #ef4444; }
        .btn-z.blue { background: var(--secondary); }

        .btn-float {
            position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px;
            background: var(--accent); border-radius: 50%; border: 3px solid #fff;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px var(--accent); z-index: 90; cursor: pointer; color: #000;
        }

        input, select {
            background: rgba(0,0,0,0.2); border: 1px solid var(--text-secondary);
            padding: 12px; border-radius: 8px; color: var(--text-primary);
            width: 100%; margin-bottom: 10px; font-weight: 600;
        }
        
        .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; max-height: 150px; overflow-y: auto; margin: 15px 0; }
        .icon-opt { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); cursor: pointer; }
        .icon-opt.selected { background: var(--accent); color: #fff; border-color: #fff; }

        .page-sec { display: none; animation: slideUp 0.3s; }
        .page-sec.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="theme-dark">

<div id="flash-overlay"></div>
<div class="app-overlay"></div>

<!-- HEADER -->
<header class="top-bar">
    <div class="logo-area">
        <div class="logo-icon">$</div>
        <div class="app-title">Controle Financeiro</div>
    </div>
    <div class="controls">
        <!-- PDF PRINT -->
        <div class="icon-btn" id="btnPrint" onclick="gerarPDF()">
            <i data-lucide="printer"></i>
        </div>
        <!-- SOM MUDO -->
        <div class="icon-btn" id="btnMute" onclick="toggleMute()">
            <i data-lucide="volume-2"></i>
        </div>
        <!-- TEMA -->
        <div class="icon-btn" id="btnTransform" onclick="toggleTheme()">
            <i data-lucide="zap"></i>
        </div>
        <input type="month" id="mesSelect">
    </div>
</header>

<!-- CONTE√öDO -->
<main class="main-content">
    <div class="scroll-area">
        
        <!-- HOME -->
        <div id="page-home" class="page-sec active">
            <div class="grid-stats">
                <div class="z-card accent">
                    <h3>Saldo Total</h3>
                    <div class="val" id="dSaldo">R$ 0,00</div>
                </div>
                <div class="z-card green">
                    <h3>Receitas</h3>
                    <div class="val" id="dRec">R$ 0,00</div>
                </div>
                <div class="z-card red">
                    <h3>Despesas</h3>
                    <div class="val" id="dDesp">R$ 0,00</div>
                </div>
            </div>

            <div class="chart-box">
                <span class="chart-title">Balan√ßo Financeiro</span>
                <canvas id="chartHomeBar"></canvas>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="chart-box" style="height: 200px;">
                    <span class="chart-title">Categorias</span>
                    <canvas id="chartHomeDoughnut"></canvas>
                </div>
                <div class="chart-box" style="height: 200px;">
                    <span class="chart-title">Fluxo</span>
                    <canvas id="chartHomeLine"></canvas>
                </div>
            </div>
        </div>

        <!-- GRANA -->
        <div id="page-grana" class="page-sec">
            <div class="grid-stats">
                <div class="z-card green"><h3>Receitas</h3><div class="val" id="gEntrada">R$ 0,00</div></div>
                <div class="z-card red"><h3>A Pagar</h3><div class="val" id="gFalta">R$ 0,00</div></div>
            </div>
            <div class="chart-box" style="height: 200px; margin-bottom: 20px;">
                <canvas id="chartGranaPie"></canvas>
            </div>
            <div id="listaTransacoes" class="trans-list"></div>
            <div class="btn-float" onclick="abrirModalTrans()"><i data-lucide="plus"></i></div>
        </div>

        <!-- MERCADO -->
        <div id="page-compras" class="page-sec">
            <div class="z-card accent"><h3>Total Carrinho</h3><div class="val" id="totalMercado">R$ 0,00</div></div>
            
            <div style="background: var(--card-bg); padding: 15px; border-radius: var(--radius); border: 1px solid var(--accent); margin-top: 20px;">
                <form id="formMercado" style="display: flex; gap: 8px;">
                    <input type="text" id="mItem" placeholder="Item" style="flex:2; margin:0">
                    <input type="number" id="mQtd" placeholder="Qtd" style="flex:1; margin:0">
                    <input type="number" id="mPreco" placeholder="R$" step="0.01" style="flex:1; margin:0">
                    <button class="btn-z" style="width: auto; padding: 0 15px;"><i data-lucide="plus"></i></button>
                </form>
            </div>
            <div id="listaMercado" class="trans-list"></div>
            <button class="btn-z red" style="margin-top: 20px;" onclick="limparMercado()">Limpar</button>
        </div>

        <!-- CARRO -->
        <div id="page-carro" class="page-sec">
            <div class="grid-stats">
                <div class="z-card blue"><h3>Km/L</h3><div class="val" id="cConsumo">--</div></div>
                <div class="z-card accent"><h3>Gasto Total</h3><div class="val" id="cGasto">R$ 0,00</div></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="chart-box" style="height: 180px;"><canvas id="chartCarroPie"></canvas></div>
                <div class="chart-box" style="height: 180px;"><canvas id="chartCarroLine"></canvas></div>
            </div>
            <div style="margin-top: 20px; display:flex; gap:10px;">
                <button class="btn-z blue" onclick="toggleForm('formGasContainer')"><i data-lucide="fuel"></i></button>
                <button class="btn-z accent" onclick="toggleForm('formManutContainer')"><i data-lucide="wrench"></i></button>
            </div>
            <div id="formGasContainer" style="display:none; margin-top:10px; background:var(--card-bg); padding:15px; border-radius:10px;">
                <form id="formGas">
                    <input type="date" id="gData" required>
                    <input type="number" id="gKm" placeholder="KM Atual" required>
                    <div style="display:flex; gap:10px;"><input type="number" id="gL" placeholder="Litros"><input type="number" id="gR" placeholder="Total R$"></div>
                    <button class="btn-z">Salvar Gasolina</button>
                </form>
            </div>
            <div id="formManutContainer" style="display:none; margin-top:10px; background:var(--card-bg); padding:15px; border-radius:10px;">
                <form id="formManut">
                    <input type="text" id="manDesc" placeholder="Descri√ß√£o">
                    <input type="number" id="manVal" placeholder="Valor R$">
                    <button class="btn-z">Salvar Manuten√ß√£o</button>
                </form>
            </div>
            <div id="listaCarro" class="trans-list"></div>
        </div>

        <!-- COFRE -->
        <div id="page-cofre" class="page-sec">
            <!-- TELA LOGIN -->
            <div id="vaultLogin" class="vault-container">
                <i data-lucide="lock" style="width: 50px; height: 50px; color: var(--accent); margin-bottom: 20px;"></i>
                <h2 style="margin-bottom: 20px;">Cofre Seguro</h2>
                
                <div class="pin-display">
                    <div class="pin-dot" id="pd1"></div><div class="pin-dot" id="pd2"></div><div class="pin-dot" id="pd3"></div><div class="pin-dot" id="pd4"></div>
                </div>

                <div class="numpad">
                    <div class="num-btn" onclick="typePin(1)">1</div><div class="num-btn" onclick="typePin(2)">2</div><div class="num-btn" onclick="typePin(3)">3</div>
                    <div class="num-btn" onclick="typePin(4)">4</div><div class="num-btn" onclick="typePin(5)">5</div><div class="num-btn" onclick="typePin(6)">6</div>
                    <div class="num-btn" onclick="typePin(7)">7</div><div class="num-btn" onclick="typePin(8)">8</div><div class="num-btn" onclick="typePin(9)">9</div>
                    <div class="num-btn del" onclick="clearPin()">C</div><div class="num-btn" onclick="typePin(0)">0</div><div class="num-btn ok" onclick="checkPin()">OK</div>
                </div>
                
                <p style="margin-top: 30px; color: var(--text-secondary); text-decoration: underline; cursor: pointer;" onclick="resetVault()">Esqueci / Resetar</p>
            </div>

            <!-- TELA CONTE√öDO -->
            <div id="vaultContent" style="display: none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <div style="display:flex; flex-direction:column;">
                        <h3>Senhas</h3>
                        <small style="color:var(--text-secondary); font-size:0.7em;">ID: <span id="userIdDisplay">---</span></small>
                    </div>
                    <button class="btn-z red" style="width: auto;" onclick="sairCofre()">Sair</button>
                </div>
                
                <!-- Backup Input -->
                <div style="margin-bottom:15px; padding:10px; border:1px solid var(--border-color); border-radius:8px;">
                    <small>Recuperar Backup (Colar ID):</small>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="restoreIdInput" placeholder="ID Antigo" style="margin:0;">
                        <button class="btn-z blue" style="width:auto;" onclick="restaurarBackup()">OK</button>
                    </div>
                </div>

                <form id="formPass" style="background:var(--card-bg); padding:15px; border-radius:10px; margin-bottom:20px;">
                    <input type="text" id="pSite" placeholder="Site/App">
                    <input type="text" id="pUser" placeholder="Usu√°rio">
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="pPass" placeholder="Senha" style="flex:1; margin:0">
                        <button class="btn-z" style="width:auto">Salvar</button>
                    </div>
                </form>
                <div id="listaSenhas" class="trans-list"></div>
            </div>
        </div>

    </div>
</main>

<!-- NAV -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="navTo('page-home', this)"><i data-lucide="layout-grid"></i><span>Home</span></div>
    <div class="nav-item" onclick="navTo('page-grana', this)"><i data-lucide="zap"></i><span>Grana</span></div>
    <div class="nav-item" onclick="navTo('page-compras', this)"><i data-lucide="shopping-cart"></i><span>Compras</span></div>
    <div class="nav-item" onclick="navTo('page-carro', this)"><i data-lucide="car"></i><span>Carro</span></div>
    <div class="nav-item" onclick="navTo('page-cofre', this)"><i data-lucide="shield"></i><span>Cofre</span></div>
</nav>

<!-- MODAL -->
<div id="modalTrans" class="modal">
    <div class="modal-content">
        <h3 style="text-align:center; color:var(--accent); margin-bottom:15px;">Lan√ßamento</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn-z" id="btnRec" style="background:var(--card-bg); border:1px solid #fff;" onclick="setTipo('receita')">Receita</button>
            <button class="btn-z" id="btnDes" style="background:var(--card-bg); border:1px solid #fff;" onclick="setTipo('despesa')">Despesa</button>
        </div>
        <input type="text" id="tDesc" placeholder="Descri√ß√£o">
        <input type="number" id="tVal" placeholder="Valor" step="0.01">
        <input type="date" id="tData">
        <label>√çcone:</label>
        <div class="icon-grid" id="iconGrid"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-z" onclick="salvarTransacao()">SALVAR</button>
            <button class="btn-z red" onclick="document.getElementById('modalTrans').classList.remove('open')">FECHAR</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // --- FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyAZxNVb44XMy0NBE0d0G6Y6U2NqWxBXP5U",
        authDomain: "finan1313.firebaseapp.com",
        projectId: "finan1313",
        storageBucket: "finan1313.firebasestorage.app",
        messagingSenderId: "92060764433",
        appId: "1:92060764433:web:d44aece91c3f6669a3a4b0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // SISTEMA DE ID (Para persist√™ncia)
    let USER_ID = localStorage.getItem('dbz_z_uid');
    if (!USER_ID) {
        USER_ID = 'u_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
        localStorage.setItem('dbz_z_uid', USER_ID);
    }

    // --- PDF GENERATOR ---
    function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // T√≠tulo
        doc.setFontSize(20);
        doc.text("Relat√≥rio Financeiro Z", 14, 22);
        doc.setFontSize(12);
        doc.text("M√™s: " + document.getElementById('mesSelect').value, 14, 30);
        
        // Resumo
        const rec = document.getElementById('dRec').innerText;
        const desp = document.getElementById('dDesp').innerText;
        const saldo = document.getElementById('dSaldo').innerText;
        doc.text(`Receita: ${rec} | Despesa: ${desp} | Saldo: ${saldo}`, 14, 40);

        // Transa√ß√µes
        let rows = [];
        transacoes.forEach(t => {
            rows.push([t.data, t.desc, t.tipo, "R$ " + t.val.toFixed(2), t.pago ? "Sim" : "N√£o"]);
        });

        doc.autoTable({
            startY: 50,
            head: [['Data', 'Descri√ß√£o', 'Tipo', 'Valor', 'Pago']],
            body: rows,
            theme: 'grid',
            styles: { fontSize: 8 },
            headStyles: { fillColor: [255, 126, 0] } // Laranja Goku
        });

        doc.save(`Relatorio_Financeiro_${document.getElementById('mesSelect').value}.pdf`);
    }

    // --- AUDIO SYSTEM ---
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let ctx = new AudioCtx();
    let isMuted = false;

    function toggleMute() {
        isMuted = !isMuted;
        const icon = isMuted ? 'volume-x' : 'volume-2';
        document.getElementById('btnMute').innerHTML = `<i data-lucide="${icon}"></i>`;
        lucide.createIcons();
    }

    function playSound(type) {
        if (isMuted) return;
        if (ctx.state === 'suspended') ctx.resume();
        const now = ctx.currentTime;

        if (type === 'click') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } 
        else if (type === 'ssj') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.exponentialRampToValueAtTime(800, now + 1.5); 
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0.5, now + 1.0);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 2.5);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(now); osc.stop(now + 2.5);

            // Aura Noise
            const bufferSize = ctx.sampleRate * 2.5; 
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

            const noise = ctx.createBufferSource();
            noise.buffer = buffer;
            const noiseFilter = ctx.createBiquadFilter();
            noiseFilter.type = 'lowpass';
            noiseFilter.frequency.setValueAtTime(400, now);
            noiseFilter.frequency.linearRampToValueAtTime(1500, now + 1.0); 
            const noiseGain = ctx.createGain();
            noiseGain.gain.setValueAtTime(0.1, now);
            noiseGain.gain.linearRampToValueAtTime(0.8, now + 1.0);
            noiseGain.gain.linearRampToValueAtTime(0, now + 2.5);
            noise.connect(noiseFilter); noiseFilter.connect(noiseGain); noiseGain.connect(ctx.destination);
            noise.start(now);
        }
        else if (type === 'tap') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(1200, now);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
            osc.start(now); osc.stop(now + 0.05);
        }
    }

    // --- LOGICA DE TEMAS ---
    let currentTheme = 0; // 0: Dark, 1: Light, 2: SSJ
    const themes = ['theme-dark', 'theme-light', 'theme-ssj'];

    function toggleTheme() {
        document.body.classList.remove(themes[currentTheme]);
        currentTheme = (currentTheme + 1) % 3;
        const newTheme = themes[currentTheme];
        playSound('click');

        if (newTheme === 'theme-ssj') {
            document.body.classList.add('transforming');
            playSound('ssj');
            setTimeout(() => {
                document.body.classList.remove('transforming');
                document.body.classList.add(newTheme);
            }, 500); 
        } else {
            document.body.classList.add(newTheme);
        }
        setTimeout(refreshAllCharts, 600);
    }

    // --- GLOBALS ---
    let transacoes = [], mercadoList = [], carroList = [];
    let tipoAtual = 'receita';
    let iconeAtual = 'zap';
    let charts = {};
    let pinBuffer = "";

    const icones = ['zap','droplet','wifi','home','smartphone','gamepad-2','coffee','shopping-cart','car','bus','gift','heart','music','book','briefcase','star','dollar-sign','lock','anchor','aperture','award','battery-charging','bell','camera','crown','diamond','dumbbell'];

    window.onload = () => {
        lucide.createIcons();
        document.getElementById('mesSelect').value = new Date().toISOString().slice(0, 7);
        
        // Render Icons
        const ig = document.getElementById('iconGrid');
        icones.forEach(ic => {
            const d = document.createElement('div'); d.className = 'icon-opt';
            d.innerHTML = `<i data-lucide="${ic}"></i>`;
            d.onclick = () => {
                document.querySelectorAll('.icon-opt').forEach(x => x.classList.remove('selected'));
                d.classList.add('selected'); iconeAtual = ic; playSound('tap');
            };
            ig.appendChild(d);
        });

        document.getElementById('mesSelect').addEventListener('change', carregarDados);
        carregarDados();
    };

    function navTo(pageId, el) {
        playSound('click');
        document.querySelectorAll('.page-sec').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        el.classList.add('active');
        
        if(pageId==='page-cofre') sairCofre();
        refreshAllCharts();
    }

    function getDocRef() { return db.collection('users').doc(USER_ID).collection('meses').doc(document.getElementById('mesSelect').value); }

    async function carregarDados() {
        const doc = await getDocRef().get();
        if(doc.exists) {
            const d = doc.data();
            transacoes = d.lancamentos || [];
            mercadoList = d.mercado || [];
            carroList = d.carro || [];
        } else {
            transacoes = []; mercadoList = []; carroList = [];
        }
        renderAll();
    }

    function renderAll() {
        renderTransacoes();
        renderMercadoList();
        renderCarroList();
        refreshAllCharts();
    }

    // --- GRANA ---
    function setTipo(t) {
        playSound('tap');
        tipoAtual = t;
        const bR = document.getElementById('btnRec'), bD = document.getElementById('btnDes');
        if(t==='receita') { bR.style.background='#22c55e'; bR.style.color='#fff'; bD.style.background='rgba(0,0,0,0.2)'; }
        else { bD.style.background='#ef4444'; bD.style.color='#fff'; bR.style.background='rgba(0,0,0,0.2)'; }
    }

    function abrirModalTrans() { playSound('click'); document.getElementById('modalTrans').classList.add('open'); }

    async function salvarTransacao() {
        const desc = document.getElementById('tDesc').value, val = parseFloat(document.getElementById('tVal').value);
        if(!desc || !val) return;
        playSound('ssj'); 
        transacoes.push({ id: Date.now(), tipo: tipoAtual, desc, val, data: document.getElementById('tData').value, icon: iconeAtual, pago: false });
        await getDocRef().set({ lancamentos: transacoes }, { merge: true });
        document.getElementById('modalTrans').classList.remove('open');
        renderTransacoes();
    }

    async function togglePago(id) {
        playSound('tap');
        const idx = transacoes.findIndex(t => t.id === id);
        if(idx > -1) { transacoes[idx].pago = !transacoes[idx].pago; await getDocRef().update({ lancamentos: transacoes }); renderTransacoes(); }
    }

    async function delItem(arr, id) {
        if(!confirm('Excluir?')) return;
        if(arr==='transacoes') transacoes=transacoes.filter(t=>t.id!==id);
        else if(arr==='mercado') mercadoList.splice(id,1);
        else carroList.splice(id,1);
        await getDocRef().set({ lancamentos:transacoes, mercado:mercadoList, carro:carroList }, {merge:true});
        renderAll();
    }

    function renderTransacoes() {
        const div = document.getElementById('listaTransacoes'); div.innerHTML='';
        let rec=0, desp=0, pago=0;
        transacoes.sort((a,b)=>new Date(a.data)-new Date(b.data));
        transacoes.forEach(t => {
            if(t.tipo==='receita') rec+=t.val;
            else { desp+=t.val; if(t.pago) pago+=t.val; }
            div.innerHTML += `
            <div class="trans-item ${t.tipo==='receita'?'receita':(t.pago?'pago':'despesa')}">
                <div style="display:flex; align-items:center; gap:10px;">
                    <i data-lucide="${t.icon}"></i>
                    <div><strong>${t.desc}</strong><br><small>${t.data||''}</small></div>
                </div>
                <div style="text-align:right">
                    <div>R$ ${t.val.toFixed(2)}</div>
                    ${t.tipo==='despesa' ? `<i data-lucide="${t.pago?'check-circle':'circle'}" onclick="togglePago(${t.id})" style="cursor:pointer; color:${t.pago?'#22c55e':'#fff'}"></i>` : ''}
                    <i data-lucide="trash-2" onclick="delItem('transacoes',${t.id})" style="cursor:pointer; margin-left:8px; color:#ef4444"></i>
                </div>
            </div>`;
        });
        document.getElementById('gEntrada').innerText=`R$ ${rec.toFixed(2)}`;
        document.getElementById('gFalta').innerText=`R$ ${(desp-pago).toFixed(2)}`;
        // Home
        document.getElementById('dRec').innerText=`R$ ${rec.toFixed(2)}`;
        document.getElementById('dDesp').innerText=`R$ ${desp.toFixed(2)}`;
        document.getElementById('dSaldo').innerText=`R$ ${(rec-pago).toFixed(2)}`;
        lucide.createIcons();
    }

    // --- MERCADO ---
    document.getElementById('formMercado').onsubmit = async (e) => {
        e.preventDefault();
        mercadoList.push({ item: document.getElementById('mItem').value, qtd: document.getElementById('mQtd').value, preco: document.getElementById('mPreco').value });
        await getDocRef().update({ mercado: mercadoList }); renderMercadoList(); e.target.reset();
    };
    function renderMercadoList() {
        const div = document.getElementById('listaMercado'); div.innerHTML=''; let total=0;
        mercadoList.forEach((i, idx) => {
            let sub = i.qtd*i.preco; total+=sub;
            div.innerHTML += `<div class="trans-item"><div>${i.qtd}x ${i.item}</div><div>R$ ${sub.toFixed(2)} <i data-lucide="trash-2" onclick="delItem('mercado',${idx})"></i></div></div>`;
        });
        document.getElementById('totalMercado').innerText=`R$ ${total.toFixed(2)}`;
        lucide.createIcons();
    }
    async function limparMercado() { if(confirm('Limpar?')) { mercadoList=[]; await getDocRef().update({mercado:[]}); renderMercadoList(); } }

    // --- CARRO ---
    function toggleForm(id) { document.getElementById(id).style.display = document.getElementById(id).style.display==='none'?'block':'none'; }
    document.getElementById('formGas').onsubmit = async(e) => {
        e.preventDefault();
        carroList.push({ type:'gas', data: document.getElementById('gData').value, km: document.getElementById('gKm').value, litros: document.getElementById('gL').value, valor: parseFloat(document.getElementById('gR').value) });
        await saveCar(); e.target.reset(); toggleForm('formGasContainer');
    };
    document.getElementById('formManut').onsubmit = async(e) => {
        e.preventDefault();
        carroList.push({ type:'man', desc: document.getElementById('manDesc').value, valor: parseFloat(document.getElementById('manVal').value) });
        await saveCar(); e.target.reset(); toggleForm('formManutContainer');
    };
    async function saveCar() { await getDocRef().update({ carro: carroList }); renderCarroList(); }
    function renderCarroList() {
        const div = document.getElementById('listaCarro'); div.innerHTML=''; let total=0, gas=[];
        carroList.forEach((i, idx) => {
            total+=i.valor; if(i.type==='gas') gas.push(i);
            div.innerHTML += `<div class="trans-item"><div>${i.type==='gas'?'‚õΩ '+i.km+'km':'üîß '+i.desc}</div><div>R$ ${i.valor.toFixed(2)} <i data-lucide="trash-2" onclick="delItem('carro',${idx})"></i></div></div>`;
        });
        document.getElementById('cGasto').innerText=`R$ ${total.toFixed(2)}`;
        gas.sort((a,b)=>a.km-b.km);
        if(gas.length>1) document.getElementById('cConsumo').innerText = ((gas[gas.length-1].km - gas[gas.length-2].km)/gas[gas.length-1].litros).toFixed(1);
        lucide.createIcons();
    }

    // --- GR√ÅFICOS ---
    function destroyChart(id) { if(charts[id]) charts[id].destroy(); }
    
    function refreshAllCharts() {
        const textColor = document.body.classList.contains('theme-light') ? '#333' : '#fff';
        Chart.defaults.color = textColor;
        Chart.defaults.font.family = "'Nunito', sans-serif";
        
        // 1. Home Bar (Rec vs Desp)
        let rec=0, desp=0;
        transacoes.forEach(t => t.tipo==='receita'?rec+=t.val:desp+=t.val);
        destroyChart('homeBar');
        if(document.getElementById('chartHomeBar')) {
            charts.homeBar = new Chart(document.getElementById('chartHomeBar'), {
                type: 'bar', data: { labels: ['Receita', 'Despesa'], datasets: [{ data: [rec, desp], backgroundColor: ['#22c55e', '#ef4444'], borderRadius: 8 }] },
                options: { plugins: { legend: {display:false} }, scales: { y: { ticks: { color: textColor } }, x: { ticks: { color: textColor } } } }
            });
        }

        // 2. Home Doughnut (Cats)
        let cats={};
        transacoes.forEach(t => { if(t.tipo==='despesa') cats[t.icon] = (cats[t.icon]||0)+t.val; });
        destroyChart('homePie');
        if(document.getElementById('chartHomeDoughnut')) {
            charts.homePie = new Chart(document.getElementById('chartHomeDoughnut'), {
                type: 'doughnut', 
                data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#ff7e00','#2855ff','#ffee00','#00e676','#d500f9'] }] },
                options: { 
                    plugins: { 
                        legend: { position:'bottom', labels: { usePointStyle: true, padding: 15 } } 
                    },
                    layout: { padding: { top: 20 } }
                }
            });
        }

        // 3. Grana Pie (Pago/Pendente)
        let pago=0, pendente=0;
        transacoes.forEach(t => { if(t.tipo==='despesa') t.pago ? pago+=t.val : pendente+=t.val; });
        destroyChart('granaPie');
        if(document.getElementById('chartGranaPie')) {
            charts.granaPie = new Chart(document.getElementById('chartGranaPie'), {
                type: 'pie', data: { labels: ['Pago', 'Pendente'], datasets: [{ data: [pago, pendente], backgroundColor: ['#2855ff', '#ef4444'] }] },
                options: { plugins: { legend: { labels: { usePointStyle: true } } } }
            });
        }

        // 5. Carro Line
        let gasLogs = carroList.filter(x=>x.type==='gas').sort((a,b)=>new Date(a.data)-new Date(b.data));
        destroyChart('carroLine');
        if(document.getElementById('chartCarroLine')) {
            charts.carroLine = new Chart(document.getElementById('chartCarroLine'), {
                type: 'line', data: { labels: gasLogs.map(g=>g.data), datasets: [{ label: 'R$', data: gasLogs.map(g=>g.valor), borderColor: '#ffee00', pointStyle: 'circle' }] },
                options: { plugins: { legend: {display:false} }, scales: { x: {display:false}, y: { ticks: { color: textColor } } } }
            });
        }
    }

    // --- COFRE PIN ---
    function typePin(n) {
        if(pinBuffer.length < 4) {
            playSound('tap');
            pinBuffer += n;
            updatePinDots();
        }
    }
    function clearPin() { pinBuffer = ""; updatePinDots(); playSound('tap'); }
    function updatePinDots() {
        for(let i=1; i<=4; i++) {
            const d = document.getElementById('pd'+i);
            if(i <= pinBuffer.length) d.classList.add('filled');
            else d.classList.remove('filled');
        }
    }
    function checkPin() {
        const saved = localStorage.getItem('dbz_vault_pin');
        if(!saved) { if(pinBuffer.length===4) { localStorage.setItem('dbz_vault_pin', pinBuffer); entrarCofre(); } }
        else { if(pinBuffer===saved) entrarCofre(); else { alert('PIN ERRADO!'); clearPin(); } }
    }
    function entrarCofre() { 
        playSound('ssj');
        document.getElementById('vaultLogin').style.display='none'; 
        document.getElementById('vaultContent').style.display='block'; 
        document.getElementById('userIdDisplay').innerText = USER_ID;
        carregarSenhas(); clearPin(); 
    }
    function sairCofre() { 
        document.getElementById('vaultLogin').style.display='flex'; 
        document.getElementById('vaultContent').style.display='none'; 
        clearPin(); 
    }
    function resetVault() {
        if(confirm('Resetar PIN?')) { localStorage.removeItem('dbz_vault_pin'); clearPin(); alert('Crie novo PIN'); }
    }
    function restaurarBackup() {
        const oldID = document.getElementById('restoreIdInput').value.trim();
        if(oldID && confirm('Isso carregar√° dados do ID: ' + oldID)) {
            USER_ID = oldID;
            localStorage.setItem('dbz_z_uid', USER_ID);
            document.getElementById('userIdDisplay').innerText = USER_ID;
            carregarDados();
            alert('Dados carregados! (Pode ser necess√°rio recarregar a p√°gina)');
        }
    }
    
    async function carregarSenhas() {
        const doc = await db.collection('users').doc(USER_ID).collection('vault').doc('data').get();
        const lista = doc.exists ? (doc.data().itens || []) : [];
        const div = document.getElementById('listaSenhas'); div.innerHTML='';
        lista.forEach((i, idx) => {
            div.innerHTML += `<div class="trans-item"><div><strong>${i.site}</strong><br><small>${i.user}</small></div><div><span style="filter:blur(5px)" onclick="this.style.filter='none'">${i.pass}</span> <i data-lucide="trash-2" onclick="delSenha(${idx})" style="margin-left:10px; cursor:pointer"></i></div></div>`;
        });
        lucide.createIcons();
    }
    document.getElementById('formPass').onsubmit = async (e) => {
        e.preventDefault();
        const doc = await db.collection('users').doc(USER_ID).collection('vault').doc('data').get();
        let lista = doc.exists ? (doc.data().itens || []) : [];
        lista.push({ site: document.getElementById('pSite').value, user: document.getElementById('pUser').value, pass: document.getElementById('pPass').value });
        await db.collection('users').doc(USER_ID).collection('vault').doc('data').set({ itens: lista });
        e.target.reset(); carregarSenhas();
    };
    async function delSenha(idx) {
        if(confirm('Apagar?')) {
            const doc = await db.collection('users').doc(USER_ID).collection('vault').doc('data').get();
            let lista = doc.data().itens; lista.splice(idx, 1);
            await db.collection('users').doc(USER_ID).collection('vault').doc('data').set({ itens: lista });
            carregarSenhas();
        }
    }
</script>
</body>
</html>
