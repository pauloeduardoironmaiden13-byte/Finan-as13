<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <!-- ADAPTAÇÃO MOBILE: Zoom bloqueado e escala fixa -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controle Financeiro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Ícones -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;1,600&family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            /* --- Dark Mode (Padrão) --- */
            --bg-body: #050505;
            --sidebar-bg: rgba(10, 10, 10, 0.98);
            --content-bg: rgba(20, 20, 20, 0.4);
            --card-bg: rgba(30, 30, 30, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent-color: #00d2d3;
            --accent-hover: rgba(0, 210, 211, 0.15);
            --danger: #ff6b6b;
            --success: #00b894;
            --input-bg: rgba(0, 0, 0, 0.5);
            --glass-blur: 25px;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --nav-active-bg: var(--accent-color);
            --nav-active-text: #000;
        }

        /* --- Light Mode --- */
        body.light-mode {
            --bg-body: #ffffff;
            --sidebar-bg: #ffffff;
            --content-bg: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(255, 255, 255, 0.75); 
            --border-color: rgba(0, 0, 0, 0.1);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-color: #15803d; /* Verde Escuro */
            --accent-hover: rgba(21, 128, 61, 0.1);
            --input-bg: rgba(255, 255, 255, 0.9);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            --nav-active-bg: linear-gradient(135deg, #15803d, #166534);
            --nav-active-text: #ffffff;
        }

        * { 
            box-sizing: border-box; 
            outline: none; 
            -webkit-tap-highlight-color: transparent; 
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            transition: background-color 0.4s ease, color 0.4s ease;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- LAYOUT --- */
        .app-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 25px 15px;
            backdrop-filter: blur(var(--glass-blur));
            z-index: 20;
            transition: all 0.3s ease;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            padding-left: 5px;
        }

        .custom-logo-svg {
            width: 48px;
            height: 48px;
            filter: drop-shadow(0 0 5px rgba(var(--accent-color), 0.4));
        }

        .logo-text { display: flex; flex-direction: column; line-height: 1.1; }
        .logo-title { font-family: 'Playfair Display', serif; font-size: 1.25em; font-weight: 600; font-style: italic; color: var(--accent-color); letter-spacing: 0.5px; }
        .logo-subtitle { font-family: 'Poppins', sans-serif; font-size: 0.85em; font-weight: 300; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 2px; }

        nav { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; }

        nav a {
            text-decoration: none;
            color: var(--text-secondary);
            padding: 12px 15px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        nav a:hover {
            background: var(--accent-hover);
            color: var(--accent-color);
            transform: translateX(3px);
        }
        
        nav a.special-link { color: var(--accent-color); }
        nav a.special-link:hover { color: var(--accent-color); filter: brightness(1.2); }

        nav a.active {
            background: var(--nav-active-bg);
            color: var(--nav-active-text) !important;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-sidebar {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8em;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.3s;
        }
        .btn-sidebar:hover { border-color: var(--accent-color); color: var(--accent-color); background: var(--accent-hover); }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background: radial-gradient(circle at top right, rgba(0, 210, 211, 0.05), transparent 40%);
        }

        .top-bar {
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .page-title { font-size: 1.4em; font-weight: 600; color: var(--text-primary); letter-spacing: -0.5px; }

        .live-clock {
            font-size: 0.85em; font-weight: 600; color: var(--accent-color); margin-right: 20px; background: var(--accent-hover); padding: 6px 12px; border-radius: 20px;
            display: flex; align-items: center; gap: 6px; border: 1px solid var(--border-color);
        }

        .controls { display: flex; align-items: center; gap: 15px; }

        input[type="month"] { background: var(--input-bg); border: 1px solid var(--accent-color); color: var(--text-primary); padding: 8px 12px; border-radius: 8px; font-family: 'Poppins', sans-serif; cursor: pointer; font-size: 0.9em; }

        .theme-toggle-btn { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); width: 40px; height: 40px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .theme-toggle-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }

        .scroll-area { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 20px; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px;
        }
        .scroll-area::-webkit-scrollbar { width: 5px; }
        .scroll-area::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }

        .page-section { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); max-width: 1200px; margin: 0 auto; }
        .page-section.active { display: block; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            position: relative;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); border-color: var(--accent-color); }

        .card h3 { font-size: 0.8em; color: var(--text-secondary); margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
        .card .value { font-size: 2.2em; font-weight: 700; color: var(--text-primary); }
        .card.income .value { color: #00b894; }
        .card.expense .value { color: #ff7675; }
        .card.balance .value { color: var(--accent-color); }

        .charts-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .chart-container { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; height: 350px; box-shadow: var(--shadow); position: relative; }

        .input-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .input-wrapper { display: flex; flex-direction: column; gap: 8px; position: relative; }
        .input-wrapper i.icon-left { position: absolute; left: 12px; top: 44px; color: var(--text-secondary); width: 18px; height: 18px; pointer-events: none; }
        .input-wrapper.has-icon input { padding-left: 40px; }

        label { font-size: 0.85em; color: var(--text-secondary); font-weight: 500; display: flex; align-items: center; gap: 6px; }

        input, select, textarea { 
            background: var(--input-bg); 
            border: 1px solid var(--accent-color); 
            border-radius: 8px; 
            padding: 12px 15px; 
            color: var(--text-primary); 
            font-family: 'Poppins', sans-serif; 
            transition: all 0.3s; 
            width: 100%; 
            font-size: 16px;
            user-select: text;
            -webkit-user-select: text;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-hover); }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), rgba(0, 210, 211, 0.6));
            color: #000; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 15px var(--accent-hover);
        }
        body.light-mode .btn-primary { color: #fff; background: var(--nav-active-bg); }
        .btn-primary:hover { transform: translateY(-2px); filter: brightness(1.1); }
        
        .btn-outline { background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: 0.3s; }
        .btn-outline:hover { background: var(--accent-hover); }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        
        .btn-danger { background: rgba(255, 107, 107, 0.1); border: 1px solid var(--danger); color: var(--danger); padding: 8px 15px; border-radius: 8px; cursor: pointer; }
        .btn-danger:hover { background: var(--danger); color: #fff; }

        /* Estilo do Resumo Financeiro */
        .finance-summary-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            backdrop-filter: blur(10px);
        }
        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }
        .summary-item span {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .summary-item strong {
            font-size: 1.2em;
            font-weight: 700;
        }
        .text-success { color: var(--success) !important; }
        .text-danger { color: var(--danger) !important; }

        .modern-list { list-style: none; padding: 0; margin-top: 20px; }
        .modern-list li { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; transition: all 0.2s; }
        .modern-list li:hover { transform: translateX(5px); border-color: var(--accent-color); background: var(--accent-hover); }
        .list-info strong { display: block; color: var(--text-primary); font-size: 1em; }
        .list-info small { color: var(--text-secondary); font-size: 0.85em; }

        .delete-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .delete-btn:hover { color: var(--danger); border-color: var(--danger); background: rgba(255, 107, 107, 0.1); }

        h2 { color: var(--text-primary); font-size: 1.5em; margin-bottom: 25px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        h3 { color: var(--text-primary); margin-bottom: 15px; font-size: 1.1em; display: flex; align-items: center; gap: 8px; }

        /* --- Modais --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal.open { display: flex; }
        .modal-content { background: var(--sidebar-bg); border: 1px solid var(--accent-color); padding: 30px; border-radius: 15px; width: 90%; max-width: 450px; box-shadow: 0 0 40px rgba(0,0,0,0.5); position: relative; max-height: 90vh; overflow-y: auto; }
        
        .icon-selector { display: flex; gap: 10px; margin: 15px 0; justify-content: center; flex-wrap: wrap; height: 150px; overflow-y: auto; }
        .icon-option { width: 42px; height: 42px; border-radius: 10px; border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); transition: 0.2s; flex-shrink: 0; }
        .icon-option:hover, .icon-option.selected { background: var(--accent-color); color: var(--bg-body); border-color: var(--accent-color); transform: scale(1.1); }

        .category-tag { display: inline-flex; align-items: center; background: var(--card-bg); padding: 6px 14px; border-radius: 20px; margin: 5px; font-size: 0.9em; border: 1px solid var(--border-color); color: var(--text-primary); }
        
        .remove-wrapper { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            width: 30px; 
            height: 30px; 
            margin-left: 8px; 
            cursor: pointer; 
            border-radius: 50%;
            transition: 0.2s;
            background: rgba(255, 255, 255, 0.05); 
        }
        .remove-wrapper:hover { background: rgba(255, 107, 107, 0.2); }
        .remove-wrapper i { pointer-events: none; }
        .remove-wrapper:hover i { color: var(--danger); }

        /* ABAS MODAL */
        .modal-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .modal-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: var(--text-secondary); border-radius: 8px; font-weight: 500; transition: 0.2s; }
        .modal-tab.active { background: var(--accent-hover); color: var(--accent-color); font-weight: bold; }

        /* TOAST NOTIFICATION */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--accent-color);
            color: var(--bg-body);
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        /* CALENDÁRIO */
        .calendar-container { background: var(--card-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--border-color); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; text-align: center; }
        .calendar-day-name { font-weight: 600; color: var(--text-secondary); font-size: 0.9em; margin-bottom: 10px; }
        .calendar-day { 
            height: 80px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; position: relative; transition: 0.2s; display: flex; flex-direction: column; align-items: flex-start; padding: 5px;
            background: var(--input-bg);
        }
        .calendar-day:hover { border-color: var(--accent-color); background: var(--accent-hover); }
        .calendar-day.empty { background: transparent; border: none; cursor: default; }
        .day-number { font-weight: bold; font-size: 0.9em; margin-bottom: 4px; }
        .day-indicator { width: 6px; height: 6px; background-color: var(--accent-color); border-radius: 50%; display: inline-block; margin-right: 2px; }

        @media (max-width: 768px) {
            .app-wrapper { flex-direction: column; }
            .sidebar { 
                width: 100%; 
                height: 70px; 
                flex-direction: row; 
                justify-content: space-around; 
                align-items: center; 
                padding: 0; 
                position: fixed; 
                bottom: 0; 
                left: 0; 
                border-right: none; 
                border-top: 1px solid var(--border-color); 
                order: 2; 
                background: var(--sidebar-bg);
                z-index: 1000;
            }
            .logo-container { display: none; }
            .logo-text { display: none; }
            .sidebar-footer { display: none; } 
            
            nav { 
                flex-direction: row; 
                justify-content: space-evenly; 
                width: 100%; 
                height: 100%;
                gap: 0;
            }
            nav a { 
                flex-direction: column; 
                padding: 5px; 
                font-size: 0.65em; 
                gap: 4px; 
                border-radius: 8px; 
                border: none; 
                flex: 1; 
                justify-content: center;
                text-align: center;
                height: 100%;
            }
            nav a i { width: 20px; height: 20px; }
            
            .main-content { order: 1; margin-bottom: 70px; }
            .top-bar { padding: 0 15px; }
            .page-title { font-size: 1.2em; }
            
            .dashboard-grid { grid-template-columns: 1fr; }
            .charts-wrapper { grid-template-columns: 1fr; }
            .calendar-day { height: 50px; }
            .input-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="app-wrapper">
    
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo-container">
            <svg class="custom-logo-svg" viewBox="0 0 40 40" fill="none" stroke="var(--accent-color)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 38c9.941 0 18-8.059 18-18S29.941 2 20 2 2 10.059 2 20s8.059 18 18 18z" stroke-opacity="0.2" />
                <path d="M12 26v-4" />
                <path d="M18 26v-8" />
                <path d="M24 26v-12" />
                <path d="M8 22l6-4 6 6 10-12" stroke-width="2" />
                <text x="32" y="16" font-family="Poppins" font-weight="bold" font-size="14" fill="var(--accent-color)" stroke="none">$</text>
            </svg>
            <div class="logo-text">
                <span class="logo-title">Controle</span>
                <span class="logo-subtitle">Financeiro</span>
            </div>
        </div>
        
        <nav>
            <a href="#principal" class="nav-link active"><i data-lucide="layout-dashboard"></i> <span>Home</span></a>
            <a href="#financeiro" class="nav-link"><i data-lucide="dollar-sign"></i> <span>Finanças</span></a>
            <a href="#compras" class="nav-link"><i data-lucide="shopping-cart"></i> <span>Mercado</span></a>
            <a href="#carro" class="nav-link"><i data-lucide="car"></i> <span>Carro</span></a>
            <a href="#agenda" class="nav-link"><i data-lucide="calendar"></i> <span>Agenda</span></a>
            <a href="#cofre" class="nav-link special-link"><i data-lucide="lock"></i> <span>Cofre</span></a>
        </nav>

        <div class="sidebar-footer">
            <button class="btn-sidebar" onclick="zerarDadosMes()" style="border-color: var(--danger); color: var(--danger); margin-bottom: 10px;"><i data-lucide="trash-2"></i> Limpar Dados do Mês</button>
            <button class="btn-sidebar" onclick="exportarDadosGerais()"><i data-lucide="download"></i> Exportar Dados</button>
            <button class="btn-sidebar" onclick="document.getElementById('inputImportarGeral').click()"><i data-lucide="upload"></i> Importar Dados</button>
            <input type="file" id="inputImportarGeral" style="display: none;" accept=".json" onchange="importarDadosGerais(this)">
        </div>
    </aside>

    <!-- ÁREA PRINCIPAL -->
    <main class="main-content">
        <header class="top-bar">
            <div class="page-title" id="pageTitleDisplay">Dashboard</div>
            <div style="display: flex; align-items: center;">
                <div class="live-clock" id="liveClock" style="display:none;"><i data-lucide="clock" style="width:14px;"></i> --:--</div>
                <div class="controls">
                    <input type="month" id="seletorMes">
                    <button class="theme-toggle-btn" id="themeToggle"><i data-lucide="sun"></i></button>
                </div>
            </div>
        </header>

        <div class="scroll-area">
            
            <!-- PÁGINA: PRINCIPAL -->
            <div id="page-principal" class="page-section active">
                <div class="dashboard-grid">
                    <div class="card income">
                        <h3>Receitas</h3>
                        <div class="value" id="totalReceitasPrincipal">R$ 0,00</div>
                    </div>
                    <div class="card expense">
                        <h3>Despesas</h3>
                        <div class="value" id="totalDespesasPrincipal">R$ 0,00</div>
                    </div>
                    <div class="card balance">
                        <h3>Saldo Líquido</h3>
                        <div class="value" id="saldoFinalPrincipal">R$ 0,00</div>
                    </div>
                </div>

                <div class="charts-wrapper">
                    <div class="chart-container">
                        <h3 style="text-align: center;">Distribuição de Gastos</h3>
                        <canvas id="graficoDespesas"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="text-align: center;">Fatura Cartão</h3>
                        <canvas id="graficoCartaoBarras"></canvas>
                    </div>
                </div>
            </div>

            <!-- PÁGINA: FINANCEIRO -->
            <div id="page-financeiro" class="page-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Financeiro</h2>
                    <button class="btn-primary btn-small" id="btnGerenciarCategorias"><i data-lucide="settings"></i> Categorias</button>
                </div>

                <!-- Resumo Financeiro -->
                <div class="finance-summary-card">
                    <div class="summary-item">
                        <span><i data-lucide="trending-up" style="color:var(--success)"></i> Total Receitas</span>
                        <strong id="displayTotalReceitas" class="text-success">R$ 0,00</strong>
                    </div>
                    <div class="summary-item">
                        <span><i data-lucide="trending-down" style="color:var(--danger)"></i> Total Despesas</span>
                        <strong id="displayTotalDespesas" class="text-danger">R$ 0,00</strong>
                    </div>
                    <div class="summary-item">
                        <span><i data-lucide="scale"></i> Saldo</span>
                        <strong id="displaySaldoFinanceiro">R$ 0,00</strong>
                    </div>
                </div>

                <h3 style="color: var(--success); display:flex; align-items:center; gap:8px;">
                    <i data-lucide="banknote" style="width:20px;"></i> Receitas
                </h3>
                <div id="containerReceitas" class="input-grid"></div>
                
                <div style="margin-bottom: 30px;">
                    <button class="btn-primary" onclick="salvarEntradas()"><i data-lucide="save"></i> Salvar Receitas</button>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="color: var(--danger); display:flex; align-items:center; gap:8px;">
                        <i data-lucide="trending-down" style="width:20px;"></i> Despesas
                    </h3>
                    <button class="btn-danger btn-small" onclick="limparDespesasManual()" style="height: 32px;"><i data-lucide="trash-2" style="width:14px; margin-right:5px;"></i> Limpar Despesas</button>
                </div>
                <div id="containerDespesasFixas" class="input-grid"></div>

                <div class="input-wrapper has-icon" style="margin-top: 10px; max-width: 300px;">
                    <label>Fatura Cartão</label>
                    <i data-lucide="credit-card" class="icon-left"></i>
                    <input type="number" id="cartaoCredito" class="despesa-input" placeholder="0,00" style="border-color: var(--danger);">
                </div>
            </div>

            <!-- PÁGINA: MERCADO -->
            <div id="page-compras" class="page-section">
                <h2>Mercado & VA</h2>
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>Valor do Vale</h3>
                        <input type="number" id="valorTotalVA" placeholder="R$ 0,00" style="background: transparent; border: none; font-size: 1.8em; color: var(--text-primary); font-weight: bold; width: 100%; padding: 0;">
                    </div>
                    <div class="card">
                        <h3>Gasto Atual</h3>
                        <div class="value" id="totalCompras" style="color: var(--danger)">R$ 0,00</div>
                    </div>
                    <div class="card">
                        <h3>Saldo Restante</h3>
                        <div class="value" id="saldoVA" style="color: var(--accent-color)">R$ 0,00</div>
                    </div>
                </div>

                <!-- Botão Adicionar Item -->
                <form id="formAddItemCompra" style="display: flex; gap: 10px; margin-top: 30px; background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color);">
                    <input type="text" id="itemCompraDescricao" placeholder="Nome do item (ex: Arroz)" style="flex: 2;">
                    <input type="number" id="itemCompraValor" placeholder="Valor" step="0.01" style="flex: 1;">
                    <button type="submit" class="btn-primary"><i data-lucide="plus"></i></button>
                </form>

                <!-- Botão Limpar Lista -->
                <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                    <button class="btn-danger btn-small" onclick="limparListaMercado()"><i data-lucide="trash-2" style="width: 14px; margin-right: 5px;"></i> Limpar Lista</button>
                </div>

                <ul id="listaComprasContainer" class="modern-list"></ul>
            </div>

            <!-- PÁGINA: CARRO -->
            <div id="page-carro" class="page-section">
                <h2>Controle do Veículo</h2>
                <div class="input-grid">
                    <div class="card" style="padding: 20px;">
                        <h3 style="display: flex; align-items: center; gap: 8px;"><i data-lucide="fuel" style="width: 18px;"></i> Abastecer</h3>
                        <form id="formAbastecimento" style="display: flex; flex-direction: column; gap: 12px; margin-top: 15px;">
                            <input type="date" id="gasData">
                            <input type="number" id="gasKmAtual" placeholder="KM Atual">
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="gasLitros" placeholder="Litros">
                                <input type="number" id="gasValorTotal" placeholder="Total R$">
                            </div>
                            <button type="submit" class="btn-primary" style="margin-top: 5px;">Registrar</button>
                        </form>
                    </div>
                    
                    <div class="card" style="padding: 20px;">
                        <h3 style="display: flex; align-items: center; gap: 8px;"><i data-lucide="wrench" style="width: 18px;"></i> Manutenção</h3>
                        <form id="formManutencao" style="display: flex; flex-direction: column; gap: 12px; margin-top: 15px;">
                            <input type="date" id="manutencaoData">
                            <input type="text" id="manutencaoDescricao" placeholder="Descrição">
                            <input type="number" id="manutencaoValor" placeholder="Valor R$">
                            <button type="submit" class="btn-primary" style="margin-top: 5px;">Registrar</button>
                        </form>
                    </div>
                </div>
                <h3>Histórico</h3>
                <ul id="listaAbastecimento" class="modern-list"></ul>
            </div>

            <!-- PÁGINA: AGENDA -->
            <div id="page-agenda" class="page-section">
                <h2>Agenda & Calendário</h2>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h3 id="calendarMonthYear">Mês/Ano</h3>
                        <div>
                            <button class="btn-outline btn-small" onclick="mudarMesCalendario(-1)"><i data-lucide="chevron-left"></i></button>
                            <button class="btn-outline btn-small" onclick="mudarMesCalendario(1)"><i data-lucide="chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGridHeader">
                        <div class="calendar-day-name">Dom</div><div class="calendar-day-name">Seg</div><div class="calendar-day-name">Ter</div>
                        <div class="calendar-day-name">Qua</div><div class="calendar-day-name">Qui</div><div class="calendar-day-name">Sex</div>
                        <div class="calendar-day-name">Sáb</div>
                    </div>
                    <div class="calendar-grid" id="calendarDays"></div>
                </div>
                <h3 style="margin-top: 20px;">Próximos Compromissos</h3>
                <ul id="listaAgenda" class="modern-list"></ul>
            </div>

            <!-- PÁGINA: COFRE (REFEITA 3 OPÇÕES) -->
            <div id="page-cofre" class="page-section">
                <h2>Cofre de Senhas</h2>
                
                <!-- MENU INICIAL DO COFRE -->
                <div id="vaultMenu" style="display:flex; flex-direction:column; align-items:center; height:60vh; justify-content:center; gap: 15px;">
                    <i data-lucide="shield-check" style="width:64px; height:64px; color:var(--accent-color); margin-bottom:10px;"></i>
                    <h3 style="margin-bottom: 20px;">Gerenciador Seguro</h3>
                    
                    <button class="btn-primary" onclick="showVaultScreen('login')" style="width: 200px; justify-content: center;">Entrar</button>
                    <button class="btn-outline" onclick="showVaultScreen('register')" style="width: 200px; justify-content: center;">Cadastrar Senha</button>
                    <button class="btn-danger" onclick="showVaultScreen('reset')" style="width: 200px; justify-content: center;">Resetar Senha</button>
                </div>

                <!-- TELA DE LOGIN/CADASTRO -->
                <div id="vaultLockScreen" style="display:none; flex-direction:column; align-items:center; height:60vh; justify-content:center;">
                    <i data-lucide="lock" style="width:48px; height:48px; color:var(--accent-color); margin-bottom:15px;"></i>
                    <h3 id="vaultTitle">Cofre Protegido</h3>
                    <p id="vaultMsg" style="color:var(--text-secondary); margin-bottom:20px; text-align:center;">Digite a senha.</p>
                    
                    <div style="display:flex; gap:10px; width: 100%; max-width: 300px; justify-content: center;">
                        <input type="password" id="vaultPassword" placeholder="Senha" style="max-width: 180px;">
                        <button class="btn-primary" id="btnUnlockVault">Ação</button>
                    </div>
                    
                    <button class="btn-outline btn-small" onclick="backToVaultMenu()" style="margin-top: 20px;">Voltar</button>
                    <p id="vaultError" style="color:var(--danger); display:none; margin-top:10px;">Erro!</p>
                </div>
                
                <!-- CONTEÚDO DESBLOQUEADO -->
                <div id="vaultContent" style="display:none; animation: slideUp 0.3s;">
                    <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
                        <button class="btn-outline btn-small" onclick="lockVault()">Sair do Cofre</button>
                    </div>
                    <div class="card" style="margin-bottom:20px;">
                        <form id="formVaultAdd" style="display:flex; gap:10px; flex-direction: column;">
                            <input type="text" id="vTitle" placeholder="Serviço" style="flex:1;">
                            <input type="text" id="vUser" placeholder="Usuário" style="flex:1;">
                            <input type="text" id="vPass" placeholder="Senha" style="flex:1;">
                            <button type="submit" class="btn-primary">Salvar</button>
                        </form>
                    </div>
                    <div id="vaultList"></div>
                </div>
            </div>

        </div> 
    </main>
</div>

<!-- TOAST -->
<div id="toast" class="toast">Salvo com sucesso!</div>

<!-- MODAL CONFIRMAÇÃO -->
<div id="modalConfirmacao" class="modal">
    <div class="modal-content" style="text-align: center;">
        <i data-lucide="alert-triangle" style="width: 48px; height: 48px; color: var(--danger); margin-bottom: 10px;"></i>
        <h3 style="justify-content: center;">Tem certeza?</h3>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Essa ação não pode ser desfeita.</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="btnConfirmarNao" class="btn-outline">Cancelar</button>
            <button id="btnConfirmarSim" class="btn-danger">Excluir</button>
        </div>
    </div>
</div>

<!-- MODAL CATEGORIAS -->
<div id="modalCategorias" class="modal">
    <div class="modal-content">
        <h3 style="color: var(--accent-color)">Gerenciar Categorias</h3>
        
        <!-- Abas -->
        <div class="modal-tabs">
            <div class="modal-tab active" id="tabReceitas" onclick="mudarAbaCategoria('receita')">Receitas</div>
            <div class="modal-tab" id="tabDespesas" onclick="mudarAbaCategoria('despesa')">Despesas</div>
        </div>

        <div class="icon-selector">
            <div class="icon-option selected" data-icon="zap"><i data-lucide="zap"></i></div>
            <div class="icon-option" data-icon="car"><i data-lucide="car"></i></div> <!-- Carro adicionado -->
            <div class="icon-option" data-icon="dollar-sign"><i data-lucide="dollar-sign"></i></div>
            <div class="icon-option" data-icon="briefcase"><i data-lucide="briefcase"></i></div>
            <div class="icon-option" data-icon="home"><i data-lucide="home"></i></div>
            <div class="icon-option" data-icon="shopping-bag"><i data-lucide="shopping-bag"></i></div>
            <div class="icon-option" data-icon="heart"><i data-lucide="heart"></i></div>
            <div class="icon-option" data-icon="book"><i data-lucide="book"></i></div>
            <div class="icon-option" data-icon="coffee"><i data-lucide="coffee"></i></div>
            <div class="icon-option" data-icon="music"><i data-lucide="music"></i></div>
            <div class="icon-option" data-icon="gift"><i data-lucide="gift"></i></div>
            <div class="icon-option" data-icon="plane"><i data-lucide="plane"></i></div>
            <div class="icon-option" data-icon="shield"><i data-lucide="shield"></i></div>
            <div class="icon-option" data-icon="droplet"><i data-lucide="droplet"></i></div>
            <div class="icon-option" data-icon="wifi"><i data-lucide="wifi"></i></div>
            <div class="icon-option" data-icon="smartphone"><i data-lucide="smartphone"></i></div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input type="text" id="novaCategoriaInput" placeholder="Nome da Categoria">
            <button id="btnAddCategoria" class="btn-primary">Adicionar</button>
        </div>

        <div id="containerTagsCategorias" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto; margin-bottom: 20px;"></div>

        <button id="btnFecharModal" class="btn-primary" style="width: 100%;">Fechar</button>
    </div>
</div>

<!-- MODAL EVENTO AGENDA -->
<div id="modalEvento" class="modal">
    <div class="modal-content">
        <h3 style="color: var(--accent-color)">Evento / Tarefa</h3>
        <input type="hidden" id="eventoId">
        <label>Data</label>
        <input type="date" id="eventoData" style="margin-bottom: 10px;">
        <label>Hora</label>
        <input type="time" id="eventoHora" style="margin-bottom: 10px;">
        <label>Descrição</label>
        <textarea id="eventoDesc" rows="3" style="margin-bottom: 15px; resize: none;"></textarea>
        
        <div style="display: flex; gap: 10px;">
            <button id="btnSalvarEvento" class="btn-primary" style="flex: 1;">Salvar</button>
            <button onclick="document.getElementById('modalEvento').classList.remove('open')" class="btn-outline">Cancelar</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    lucide.createIcons();

    // === CONFIGURAÇÃO FIREBASE ===
    const firebaseConfig = {
        apiKey: "AIzaSyAZxNVb44XMy0NBE0d0G6Y6U2NqWxBXP5U",
        authDomain: "finan1313.firebaseapp.com",
        projectId: "finan1313",
        storageBucket: "finan1313.firebasestorage.app",
        messagingSenderId: "92060764433",
        appId: "1:92060764433:web:d44aece91c3f6669a3a4b0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Estado e Configuração
    let categoriasReceitas = [
        {name: 'Salário 1', icon: 'dollar-sign'},
        {name: 'Salário 2', icon: 'briefcase'},
        {name: 'Renda Extra', icon: 'plus-circle'}
    ];
    let categoriasDespesas = [
        {name: 'Escola', icon: 'book'},
        {name: 'Água', icon: 'droplet'},
        {name: 'Luz', icon: 'zap'},
        {name: 'Internet', icon: 'wifi'},
        {name: 'Casa', icon: 'home'},
        {name: 'Seguro', icon: 'shield'}
    ];
    
    let selectedIcon = 'zap';
    let modalAbaAtual = 'receita'; // 'receita' ou 'despesa'
    let chartDoughnut = null, chartBar = null;
    let confirmCallback = null; 
    let agendaAtual = []; 

    // Relógio
    setInterval(() => {
        const now = new Date();
        document.getElementById('liveClock').innerHTML = `<i data-lucide="clock" style="width:14px;"></i> ${now.toLocaleTimeString()}`;
        lucide.createIcons();
    }, 1000);

    // Navegação e Tema
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.page-section');
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('href').substring(1);
            navLinks.forEach(n => n.classList.remove('active'));
            link.classList.add('active');
            sections.forEach(s => s.classList.remove('active'));
            document.getElementById(`page-${targetId}`).classList.add('active');
            document.getElementById('pageTitleDisplay').innerText = link.querySelector('span').innerText;
            if(targetId === 'principal') carregarDashboard();
            if(targetId === 'cofre') backToVaultMenu();
            if(targetId === 'agenda') renderCalendar();
        });
    });

    document.getElementById('themeToggle').addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
        const isLight = document.body.classList.contains('light-mode');
        document.getElementById('themeToggle').innerHTML = isLight ? `<i data-lucide="moon"></i>` : `<i data-lucide="sun"></i>`;
        lucide.createIcons();
        atualizarGraficos();
    });

    // Mês
    const seletorMes = document.getElementById('seletorMes');
    const hoje = new Date();
    seletorMes.value = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
    seletorMes.addEventListener('change', () => recarregarTudo());
    function getMesId() { return seletorMes.value; }

    // --- MODAL CONFIRMAÇÃO ---
    function showConfirmModal(callback) {
        confirmCallback = callback;
        document.getElementById('modalConfirmacao').classList.add('open');
    }
    document.getElementById('btnConfirmarNao').addEventListener('click', () => {
        document.getElementById('modalConfirmacao').classList.remove('open');
        confirmCallback = null;
    });
    document.getElementById('btnConfirmarSim').addEventListener('click', () => {
        if(confirmCallback) confirmCallback();
        document.getElementById('modalConfirmacao').classList.remove('open');
    });

    // --- TOAST NOTIFICATION ---
    function showToast(msg) {
        const t = document.getElementById("toast");
        t.innerText = msg;
        t.className = "toast show";
        setTimeout(function(){ t.className = t.className.replace("show", ""); }, 3000);
    }

    // --- CATEGORIAS & MODAL (RECEITAS / DESPESAS) ---
    const modal = document.getElementById('modalCategorias');
    
    // Abrir Modal
    document.getElementById('btnGerenciarCategorias').addEventListener('click', () => {
        mudarAbaCategoria('receita'); // Default
        modal.classList.add('open');
    });

    // Fechar Modal e Salvar
    document.getElementById('btnFecharModal').addEventListener('click', async () => {
        modal.classList.remove('open');
        // Salva ambas as listas
        await db.collection('financas').doc(getMesId()).set({ 
            categoriasReceitas: categoriasReceitas,
            categoriasDespesas: categoriasDespesas 
        }, { merge: true });
        
        renderizarInputsFixos(); // Atualiza UI de inputs
        carregarValoresInputs();
    });

    // Seleção de Ícone
    document.querySelectorAll('.icon-option').forEach(opt => {
        opt.addEventListener('click', () => {
            document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            selectedIcon = opt.dataset.icon;
        });
    });

    // Adicionar Categoria
    document.getElementById('btnAddCategoria').addEventListener('click', async () => {
        const val = document.getElementById('novaCategoriaInput').value.trim();
        const listaAtual = modalAbaAtual === 'receita' ? categoriasReceitas : categoriasDespesas;
        
        if(val && !listaAtual.some(c => c.name === val)) {
            listaAtual.push({ name: val, icon: selectedIcon });
            document.getElementById('novaCategoriaInput').value = '';
            renderizarTagsCategorias(modalAbaAtual);
            
            // Salvar Imediatamente
            await db.collection('financas').doc(getMesId()).set({ 
                categoriasReceitas: categoriasReceitas,
                categoriasDespesas: categoriasDespesas 
            }, { merge: true });
            
            renderizarInputsFixos();
        }
    });

    // Função para mudar aba no modal
    window.mudarAbaCategoria = function(tipo) {
        modalAbaAtual = tipo;
        document.getElementById('tabReceitas').classList.toggle('active', tipo === 'receita');
        document.getElementById('tabDespesas').classList.toggle('active', tipo === 'despesa');
        renderizarTagsCategorias(tipo);
    };

    function renderizarTagsCategorias(tipo) {
        const container = document.getElementById('containerTagsCategorias');
        container.innerHTML = '';
        const lista = tipo === 'receita' ? categoriasReceitas : categoriasDespesas;

        lista.forEach((cat, index) => {
            const div = document.createElement('div');
            div.className = 'category-tag';
            div.innerHTML = `<i data-lucide="${cat.icon || 'circle'}" style="width:14px; margin-right:5px; color:var(--text-secondary)"></i> ${cat.name}`;
            
            // Botão Excluir
            const btnRemove = document.createElement('span');
            btnRemove.className = 'remove-wrapper';
            btnRemove.innerHTML = `<i data-lucide="trash-2" style="width:16px; height:16px; color:var(--text-secondary)"></i>`;
            
            btnRemove.onclick = () => {
                showConfirmModal(async () => {
                    const removedCat = lista.splice(index, 1)[0];
                    renderizarTagsCategorias(tipo);
                    
                    // ID Seguro para deletar do banco
                    const prefix = tipo === 'receita' ? 'rec_' : 'fix_';
                    const idSafe = prefix + removedCat.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    
                    // Update Firebase
                    await db.collection('financas').doc(getMesId()).update({
                        categoriasReceitas: categoriasReceitas,
                        categoriasDespesas: categoriasDespesas,
                        [idSafe]: firebase.firestore.FieldValue.delete()
                    });

                    renderizarInputsFixos();
                    recarregarTudo(); 
                });
            };
            
            div.appendChild(btnRemove);
            container.appendChild(div);
        });
        lucide.createIcons();
    }

    // Renderiza inputs na tela principal (Receitas e Despesas)
    function renderizarInputsFixos() {
        const containerRec = document.getElementById('containerReceitas');
        const containerDesp = document.getElementById('containerDespesasFixas');
        
        containerRec.innerHTML = '';
        containerDesp.innerHTML = '';

        // Receitas
        categoriasReceitas.forEach(cat => {
            const safeName = cat.name;
            const idSafe = 'rec_' + safeName.toLowerCase().replace(/[^a-z0-9]/g, '_');
            const div = document.createElement('div');
            div.className = 'input-wrapper has-icon';
            div.innerHTML = `
                <label>${safeName}</label>
                <i data-lucide="${cat.icon || 'dollar-sign'}" class="icon-left"></i>
                <input type="number" id="${idSafe}" data-cat="${safeName}" class="receita-input" placeholder="0,00">
            `;
            containerRec.appendChild(div);
        });

        // Despesas
        categoriasDespesas.forEach(cat => {
            const safeName = cat.name;
            const idSafe = 'fix_' + safeName.toLowerCase().replace(/[^a-z0-9]/g, '_');
            const div = document.createElement('div');
            div.className = 'input-wrapper has-icon';
            div.innerHTML = `
                <label>${safeName}</label>
                <i data-lucide="${cat.icon || 'circle'}" class="icon-left"></i>
                <input type="number" id="${idSafe}" data-cat="${safeName}" class="despesa-input" placeholder="0,00">
            `;
            containerDesp.appendChild(div);
        });

        lucide.createIcons();
        
        // Listeners para Receitas (Display Update only) e Despesas (Auto-save)
        document.querySelectorAll('.receita-input').forEach(input => input.addEventListener('input', atualizarTotaisTelaFinanceiro));
        document.querySelectorAll('.despesa-input').forEach(input => input.addEventListener('input', calcularFinanceiro));
    }

    // --- FUNÇÃO PARA ATUALIZAR TOTAIS NA TELA (SEM SALVAR) ---
    function atualizarTotaisTelaFinanceiro() {
        let totalReceitas = 0;
        let totalDespesas = 0;

        document.querySelectorAll('.receita-input').forEach(i => totalReceitas += parseFloat(i.value) || 0);
        document.querySelectorAll('.despesa-input').forEach(i => {
            if(i.id !== 'cartaoCredito') totalDespesas += parseFloat(i.value) || 0;
        });
        totalDespesas += parseFloat(document.getElementById('cartaoCredito').value) || 0;

        document.getElementById('displayTotalReceitas').innerText = fmt(totalReceitas);
        document.getElementById('displayTotalDespesas').innerText = fmt(totalDespesas);
        
        const saldo = totalReceitas - totalDespesas;
        const elSaldo = document.getElementById('displaySaldoFinanceiro');
        elSaldo.innerText = fmt(saldo);
        
        // Cor do Saldo
        elSaldo.classList.remove('text-success', 'text-danger');
        if(saldo >= 0) elSaldo.classList.add('text-success');
        else elSaldo.classList.add('text-danger');
    }

    // --- CALENDÁRIO & AGENDA ---
    let currentDate = new Date();
    
    function mudarMesCalendario(offset) {
        currentDate.setMonth(currentDate.getMonth() + offset);
        renderCalendar();
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        document.getElementById('calendarMonthYear').innerText = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        
        const container = document.getElementById('calendarDays');
        container.innerHTML = '';

        for(let i=0; i<firstDay; i++) {
            container.innerHTML += `<div class="calendar-day empty"></div>`;
        }

        for(let day=1; day<=daysInMonth; day++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const eventsOnDay = agendaAtual.filter(e => e.agendaData === dateStr);
            
            let indicators = '';
            eventsOnDay.forEach(() => {
                indicators += `<div class="day-indicator"></div>`;
            });

            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.innerHTML = `<span class="day-number">${day}</span><div style="display:flex; flex-wrap:wrap;">${indicators}</div>`;
            dayDiv.onclick = () => openEventoModal(dateStr);
            container.appendChild(dayDiv);
        }
    }

    function openEventoModal(dateStr, eventId = null) {
        const modalEvt = document.getElementById('modalEvento');
        document.getElementById('eventoData').value = dateStr;
        document.getElementById('eventoId').value = '';
        document.getElementById('eventoHora').value = '';
        document.getElementById('eventoDesc').value = '';

        if(eventId) {
            const evt = agendaAtual.find(e => e.id === eventId);
            if(evt) {
                document.getElementById('eventoId').value = evt.id;
                document.getElementById('eventoData').value = evt.agendaData;
                document.getElementById('eventoHora').value = evt.agendaHora;
                document.getElementById('eventoDesc').value = evt.agendaDesc;
            }
        }
        
        modalEvt.classList.add('open');
    }

    document.getElementById('btnSalvarEvento').addEventListener('click', async () => {
        const id = document.getElementById('eventoId').value;
        const dataEvt = document.getElementById('eventoData').value;
        const hora = document.getElementById('eventoHora').value;
        const desc = document.getElementById('eventoDesc').value;

        if(!dataEvt || !desc) { alert('Preencha data e descrição'); return; }

        const docRef = db.collection('financas').doc(getMesId());
        const doc = await docRef.get();
        let list = doc.exists ? (doc.data()['listaAgenda'] || []) : [];

        const newItem = {
            id: id ? parseInt(id) : Date.now(),
            agendaData: dataEvt,
            agendaHora: hora,
            agendaDesc: desc
        };

        if(id) {
            list = list.map(i => i.id == id ? newItem : i);
        } else {
            list.push(newItem);
        }

        await docRef.set({ listaAgenda: list }, { merge: true });
        document.getElementById('modalEvento').classList.remove('open');
        carregarListas(); 
    });

    // --- COFRE (NOVA LÓGICA DE 3 BOTÕES) ---
    const VAULT_KEY = 'fintech_vault_data';
    const VAULT_PASS_KEY = 'fintech_vault_master_pass';
    let vaultData = [];
    if(localStorage.getItem(VAULT_KEY)) { try { vaultData = JSON.parse(localStorage.getItem(VAULT_KEY)); } catch(e){} }

    function backToVaultMenu() {
        document.getElementById('vaultMenu').style.display = 'flex';
        document.getElementById('vaultLockScreen').style.display = 'none';
        document.getElementById('vaultContent').style.display = 'none';
        document.getElementById('vaultError').style.display = 'none';
        document.getElementById('vaultPassword').value = '';
    }

    window.showVaultScreen = function(mode) {
        document.getElementById('vaultMenu').style.display = 'none';
        
        if (mode === 'reset') {
            if(confirm('Tem certeza? Isso apaga a senha atual.')) {
                localStorage.removeItem(VAULT_PASS_KEY);
                alert('Senha resetada! Cadastre uma nova.');
                backToVaultMenu();
            } else {
                backToVaultMenu();
            }
            return;
        }

        const lockScreen = document.getElementById('vaultLockScreen');
        lockScreen.style.display = 'flex';
        const title = document.getElementById('vaultTitle');
        const msg = document.getElementById('vaultMsg');
        const btn = document.getElementById('btnUnlockVault');
        
        // Remove listener antigo para evitar duplicação
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        if (mode === 'register') {
            title.innerText = 'Cadastrar Senha';
            msg.innerText = 'Crie uma nova senha';
            newBtn.innerText = 'Salvar';
            newBtn.onclick = () => {
                const pass = document.getElementById('vaultPassword').value;
                if(pass) {
                    localStorage.setItem(VAULT_PASS_KEY, pass);
                    alert('Senha salva!');
                    backToVaultMenu();
                }
            };
        } else if (mode === 'login') {
            title.innerText = 'Entrar no Cofre';
            msg.innerText = 'Digite sua senha';
            newBtn.innerText = 'Entrar';
            newBtn.onclick = () => {
                const pass = document.getElementById('vaultPassword').value;
                const stored = localStorage.getItem(VAULT_PASS_KEY);
                if (pass === stored) {
                    unlockVault();
                } else {
                    document.getElementById('vaultError').style.display = 'block';
                    document.getElementById('vaultError').innerText = stored ? 'Senha Incorreta' : 'Nenhuma senha cadastrada!';
                }
            };
        }
    };

    function unlockVault() {
        document.getElementById('vaultLockScreen').style.display = 'none';
        document.getElementById('vaultContent').style.display = 'block';
        renderVaultList();
    }
    function lockVault() {
        backToVaultMenu();
    }

    document.getElementById('formVaultAdd').addEventListener('submit', (e) => {
        e.preventDefault();
        const t = document.getElementById('vTitle').value, u = document.getElementById('vUser').value, p = document.getElementById('vPass').value;
        if(t && p) {
            vaultData.push({ id: Date.now(), title: t, user: u, pass: p });
            localStorage.setItem(VAULT_KEY, JSON.stringify(vaultData));
            document.getElementById('formVaultAdd').reset();
            renderVaultList();
        }
    });

    function renderVaultList() {
        const c = document.getElementById('vaultList'); c.innerHTML = '';
        vaultData.forEach(i => {
            const d = document.createElement('div'); d.className = 'vault-item';
            d.style.cssText = "background:var(--input-bg); padding:15px; border-radius:10px; margin-top:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border-color);";
            d.innerHTML = `<div><strong style="color:var(--text-primary)">${i.title}</strong><br><small style="color:var(--text-secondary)">${i.user}</small></div>
            <div style="text-align:right"><span style="filter:blur(5px); cursor:pointer; font-family:monospace; color:var(--accent-color);" onclick="this.style.filter='none'">${i.pass}</span> <i data-lucide="trash-2" style="color:var(--danger); cursor:pointer; margin-left:10px;" onclick="removeVaultItem(${i.id})"></i></div>`;
            c.appendChild(d);
        });
        lucide.createIcons();
    }
    window.removeVaultItem = (id) => { 
        showConfirmModal(() => { 
            vaultData = vaultData.filter(i=>i.id!==id); 
            localStorage.setItem(VAULT_KEY, JSON.stringify(vaultData)); 
            renderVaultList(); 
        });
    };

    // --- ZERAR DADOS DO MÊS ---
    window.zerarDadosMes = function() {
        showConfirmModal(async () => {
            await db.collection('financas').doc(getMesId()).delete();
            document.querySelectorAll('input').forEach(i => i.value = '');
            recarregarTudo();
            alert('Dados do mês limpos!');
        });
    };
    
    // --- LIMPAR DESPESAS MANUAL ---
    window.limparDespesasManual = function() {
        showConfirmModal(async () => {
            let updates = { totalDespesasFixas: 0 };
            document.querySelectorAll('.despesa-input').forEach(i => {
               i.value = '';
               updates[i.id] = 0;
            });
            await db.collection('financas').doc(getMesId()).update(updates);
            showToast('Despesas limpas!');
            carregarDashboard();
            atualizarTotaisTelaFinanceiro();
        });
    };

    // --- IMPORTAR/EXPORTAR ---
    window.exportarDadosGerais = async function() {
        const doc = await db.collection('financas').doc(getMesId()).get();
        let data = {};
        if(doc.exists) data = doc.data();
        const fileName = `backup_financas_${getMesId()}.json`;
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = fileName;
        a.click();
    };

    window.importarDadosGerais = function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if(confirm(`Restaurar dados para o mês ${getMesId()}?`)) {
                    await db.collection('financas').doc(getMesId()).set(json);
                    alert('Dados restaurados!');
                    recarregarTudo();
                }
            } catch(err) { alert('Erro ao ler arquivo.'); }
        };
        reader.readAsText(file);
    };

    // --- LÓGICA GERAL ---
    async function recarregarTudo() {
        const doc = await db.collection('financas').doc(getMesId()).get();
        if(doc.exists) {
            const data = doc.data();
            if(data.categoriasReceitas) categoriasReceitas = data.categoriasReceitas;
            if(data.categoriasDespesas) categoriasDespesas = data.categoriasDespesas;
        }
        renderizarInputsFixos();
        carregarValoresInputs();
        carregarDashboard();
        carregarListas();
    }

    async function carregarValoresInputs() {
        const doc = await db.collection('financas').doc(getMesId()).get();
        if(doc.exists) {
            const data = doc.data();
            if(data.cartaoCredito) document.getElementById('cartaoCredito').value = data.cartaoCredito;
            if(data.valorTotalVA) document.getElementById('valorTotalVA').value = data.valorTotalVA;
            
            // Carrega dinâmicos
            document.querySelectorAll('.receita-input').forEach(input => { if(data[input.id]) input.value = data[input.id]; });
            document.querySelectorAll('.despesa-input').forEach(input => { if(data[input.id]) input.value = data[input.id]; });
            
            // Atualiza resumo
            atualizarTotaisTelaFinanceiro();
        } else {
            document.querySelectorAll('input[type="number"]').forEach(i => i.value = '');
            atualizarTotaisTelaFinanceiro();
        }
    }

    // NOVA FUNÇÃO: SALVAR ENTRADAS MANUALMENTE
    async function salvarEntradas() {
        let rec = 0, data = {};
        document.querySelectorAll('.receita-input').forEach(i => {
            const v = parseFloat(i.value)||0;
            rec += v;
            data[i.id] = v;
        });
        
        data.totalReceitas = rec;
        
        await db.collection('financas').doc(getMesId()).set(data, {merge:true});
        showToast("Salvo com sucesso!");
        carregarDashboard();
    }

    async function calcularFinanceiro() {
        let desp = 0, data = {};
        
        document.querySelectorAll('.despesa-input').forEach(i => { 
            const v = parseFloat(i.value)||0; 
            if(i.id!=='cartaoCredito') desp+=v; 
            data[i.id]=v; 
        });
        
        data.totalDespesasFixas = desp;
        await db.collection('financas').doc(getMesId()).set(data, {merge:true});
        carregarDashboard();
        atualizarTotaisTelaFinanceiro(); // Atualiza tela localmente também
    }
    
    document.getElementById('cartaoCredito').addEventListener('input', calcularFinanceiro);

    document.getElementById('valorTotalVA').addEventListener('input', async (e) => {
        // Correção Mercado: Atualiza saldo instantaneamente no input
        const totalCompras = parseFloat(document.getElementById('totalCompras').innerText.replace('R$','').replace('.','').replace(',','.')) || 0;
        const va = parseFloat(e.target.value) || 0;
        document.getElementById('saldoVA').innerText = fmt(va - totalCompras);

        await db.collection('financas').doc(getMesId()).set({ valorTotalVA: va }, { merge: true });
    });

    // Submissão de Formulários
    const genericSubmit = async (e, arrayName, fields, keys) => {
        e.preventDefault();
        const item = { id: Date.now() }; // ID numérico único
        let hasVal = false;
        
        fields.forEach((fid, i) => { 
            const val = document.getElementById(fid).value; 
            if(val) hasVal=true; 
            item[keys[i]] = val; 
            document.getElementById(fid).value = ''; 
        });

        if(hasVal) {
            const docRef = db.collection('financas').doc(getMesId());
            const doc = await docRef.get();
            let list = doc.exists ? (doc.data()[arrayName] || []) : [];
            list.push(item);
            await docRef.set({ [arrayName]: list }, { merge: true });
            carregarListas();
            carregarDashboard();
        }
    };
    
    document.getElementById('formAddItemCompra').addEventListener('submit', (e) => genericSubmit(e, 'listaCompras', ['itemCompraDescricao', 'itemCompraValor'], ['desc', 'val']));
    document.getElementById('formAbastecimento').addEventListener('submit', (e) => genericSubmit(e, 'listaAbastecimento', ['gasData', 'gasKmAtual', 'gasLitros', 'gasValorTotal'], ['gasData', 'gasKmAtual', 'gasLitros', 'gasValorTotal']));
    document.getElementById('formManutencao').addEventListener('submit', (e) => genericSubmit(e, 'listaManutencao', ['manutencaoData', 'manutencaoDescricao', 'manutencaoValor'], ['manutencaoData', 'manutencaoDescricao', 'manutencaoValor']));
    
    // EXCLUSÃO FIXADA
    window.removerItem = async function(arrayName, id) {
        showConfirmModal(async () => {
            const docRef = db.collection('financas').doc(getMesId());
            const doc = await docRef.get();
            if(doc.exists) {
                let list = doc.data()[arrayName] || [];
                list = list.filter(i => i.id !== id);
                await docRef.update({ [arrayName]: list });
                carregarListas();
                carregarDashboard();
            }
        });
    };

    // ZERAR LISTA MERCADO
    window.limparListaMercado = function() {
        showConfirmModal(async () => {
            const docRef = db.collection('financas').doc(getMesId());
            await docRef.update({ listaCompras: [] });
            carregarListas();
            carregarDashboard();
        });
    };

    async function carregarDashboard() {
        const doc = await db.collection('financas').doc(getMesId()).get();
        let r=0, d=0, f=0, m=0, c=0, cc=0;

        if(doc.exists) {
            const dt = doc.data();
            r = dt.totalReceitas||0; f = dt.totalDespesasFixas||0; cc = dt.cartaoCredito||0;
            if(dt.listaCompras) m = dt.listaCompras.reduce((a,b)=>a+(parseFloat(b.val)||0),0);
            if(dt.listaAbastecimento) c += dt.listaAbastecimento.reduce((a,b)=>a+(parseFloat(b.gasValorTotal)||0),0);
            if(dt.listaManutencao) c += dt.listaManutencao.reduce((a,b)=>a+(parseFloat(b.manutencaoValor)||0),0);
            d = f + m + c + cc;
        }

        document.getElementById('totalReceitasPrincipal').innerText = fmt(r);
        document.getElementById('totalDespesasPrincipal').innerText = fmt(d);
        document.getElementById('saldoFinalPrincipal').innerText = fmt(r-d);
        renderCharts(f, m, c, cc);
    }

    async function carregarListas() {
        const doc = await db.collection('financas').doc(getMesId()).get();
        if(!doc.exists) {
            document.getElementById('listaComprasContainer').innerHTML = '';
            agendaAtual = [];
            renderCalendar();
            return;
        }
        const dt = doc.data();
        
        renderList('listaComprasContainer', dt.listaCompras, 'listaCompras');
        renderList('listaAbastecimento', [...(dt.listaAbastecimento||[]), ...(dt.listaManutencao||[])], 'carro');
        
        agendaAtual = dt.listaAgenda || [];
        renderList('listaAgenda', agendaAtual, 'listaAgenda');
        
        if(document.getElementById('page-agenda').classList.contains('active')) {
            renderCalendar();
        }

        const totalM = (dt.listaCompras||[]).reduce((a,b)=>a+(parseFloat(b.val)||0),0);
        document.getElementById('totalCompras').innerText = fmt(totalM);
        const va = parseFloat(document.getElementById('valorTotalVA').value)||0;
        document.getElementById('saldoVA').innerText = fmt(va - totalM);
    }

    function renderList(target, list, type) {
        const el = document.getElementById(target); el.innerHTML = '';
        if(!list) return;
        
        if(type === 'listaAgenda') {
            list.sort((a,b) => new Date(a.agendaData) - new Date(b.agendaData));
        } else {
            list.sort((a,b) => (b.id) - (a.id)); 
        }

        list.forEach(i => {
            let txt = i.desc || (i.gasData ? `Gasolina ${i.gasLitros}L` : i.manutencaoDescricao);
            let val = i.val || i.gasValorTotal || i.manutencaoValor || 0;
            let arrName;
            if (type === 'listaCompras') arrName = 'listaCompras';
            else if (type === 'listaAgenda') arrName = 'listaAgenda';
            else if (i.gasData) arrName = 'listaAbastecimento';
            else arrName = 'listaManutencao';
            
            let html = '';
            if(type === 'listaAgenda') {
                const dateParts = i.agendaData.split('-');
                const formattedDate = `${dateParts[2]}/${dateParts[1]}`;
                html = `<li>
                    <div class="list-info" style="cursor:pointer" onclick="openEventoModal('${i.agendaData}', ${i.id})">
                        <strong>${formattedDate} - ${i.agendaHora}</strong>
                        <small>${i.agendaDesc}</small>
                    </div>
                    <button class="delete-btn" onclick="removerItem('${arrName}', ${i.id})"><i data-lucide="trash-2"></i></button>
                </li>`;
            } else {
                html = `<li>
                    <div class="list-info"><strong>${txt}</strong></div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        ${val ? `<span>${fmt(val)}</span>` : ''}
                        <button class="delete-btn" onclick="removerItem('${arrName}', ${i.id})"><i data-lucide="trash-2"></i></button>
                    </div>
                </li>`;
            }
            el.innerHTML += html;
        });
        lucide.createIcons();
    }

    function renderCharts(f, m, c, cc) {
        const ctx1 = document.getElementById('graficoDespesas').getContext('2d');
        const ctx2 = document.getElementById('graficoCartaoBarras').getContext('2d');
        const isLight = document.body.classList.contains('light-mode');
        const colors = isLight ? ['#ef4444', '#f59e0b', '#3b82f6', '#10b981'] : ['#ff6b6b', '#feca57', '#54a0ff', '#00d2d3'];
        const txt = isLight ? '#333' : '#ccc';

        if(chartDoughnut) chartDoughnut.destroy();
        chartDoughnut = new Chart(ctx1, {
            type: 'doughnut',
            data: { labels: ['Fixas', 'Mercado', 'Veículo', 'Cartão'], datasets: [{ data: [f, m, c, cc], backgroundColor: colors, borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: txt } } }, cutout: '70%' }
        });

        if(chartBar) chartBar.destroy();
        chartBar = new Chart(ctx2, {
            type: 'bar',
            data: { labels: ['Fatura Atual', 'Limite Ideal'], datasets: [{ label: 'R$', data: [cc, 3000], backgroundColor: [colors[3], 'rgba(128,128,128,0.3)'], borderRadius: 5 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: txt }, grid: { color: isLight?'#ddd':'#333'} }, x: { ticks: { color: txt }, grid: { display: false } } }, plugins: { legend: { display: false } } }
        });
    }
    
    function atualizarGraficos() { carregarDashboard(); }
    function fmt(v) { return parseFloat(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

    document.addEventListener('DOMContentLoaded', () => { 
        renderizarInputsFixos(); 
        recarregarTudo(); 
        backToVaultMenu(); // Inicia Cofre no Menu
    });
</script>
</body>
</html>
